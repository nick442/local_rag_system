I did the reverse several years ago, moving from NH to MA. You will need to file Form 1-NR/PY for 2017, reporting MA income as a part-year residence. I assume you will need to report the April capital gain on your MA tax return, as you incurred the gain while a MA resident. (I am not a lawyer or tax professional, so I don't want to state anything about this as a fact, but I would be very surprised if moving after you incurred the gain would have any affect on where you report it.)