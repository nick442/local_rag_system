The safe harbor provision is based on the tax you or the prior year. So in 2016 this helped you as your tax was substantially increased from 2015. However, by the same token in 2017 your safe harbor amount is going to be very high. Therefore if 2017 is similar you will owe penalties. The solution here is to make estimated tax payments in the quarters that you realize large gains. This is exactly what the estimated tax payments are for. Your estimate tax payments do not have to be the same. In fact if you have a sudden boost in earnings in quarter 3, then the IRS expects that quarter 3 estimated tax payment to be boosted.